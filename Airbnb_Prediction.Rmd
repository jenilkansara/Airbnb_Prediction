---
output:
  word_document: default
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, include=FALSE}
library("tidyverse")
library("tidymodels")
library("plotly")
library("skimr")
library("caret")
library("rmarkdown")
library("cowplot")
library("leaflet")

```

```{r, include=FALSE}
train <- read_csv("airbnbTrain.csv")
```
# Data Mining and Predictive Analysis





# Predicting Booking Rates of Airbnb Listings






# Washington DC






### “We, the undersigned, certify that the report submitted is our original work; all authors participated in the work in a substantial way; all authors have seen and approved the report as submitted; the text, images, illustrations, and other items included in the manuscript do not carry any infringement/ plagiarism issue upon any existing copyrighted materials.”




+---------------+--------------------------------------+
|               |   Names of the signed team members   | 
+===============+======================================+
|Contact Member |      Dharmik Bhayani                 |
|               |                                      |
+---------------+---------------+----------------------+
| Team Member 2 |       Seema Agarwal                  |
|               |                                      |
+---------------+--------------------------------------+
| Team Member 3 |       Jenil Kansara                  |
|               |                                      |
+---------------+--------------------------------------+
| Team Member 4 |       Khushboo Modi                  |
|               |                                      |
+---------------+--------------------------------------+
| Team Member 5 |       Jalvi Sheta                    |
|               |                                      |
+---------------+--------------------------------------+

```{r}

```
## 1. Executive Summary

The major part of our analysis focused on identifying the factors which can help investors achieve a high booking rate. Prediction was an integral part of our study. Accurate prediction would help an investor in focusing on properties that could give him a competitive edge. Our approach focused on looking at the data through a customer’s eyes. We tried to include in our model all variables that a customer might deem important in choosing an Airbnb. We were able to decipher some interesting facts from our results.   

Location does not play a significant role in getting a high booking rate. So for any existing property owner in DC, listing it as Airbnb would get more revenue, than renting the property to a tenant. And diversifying the investment is a good strategy to make sure your portfolio is profitable. Achieving Superhost Status will significantly increase your chances of high booking rate. While Airbnb has its own criteria for that status, things of utmost importance are catering and matching the user requirements, and maintaining a good image. Having a good response time, honouring all bookings made and great reviews will get you closer to superhost status and bring your listing to the top. 

We have tried at every point to make sure that all our findings can be explained and it is not just a black box prediction methodology. This helped us in building a strong business case with clearly explained variables and results. Still, the degree of reliance on the model would depend on what the business requirements are. Combining human judgement and the insights from the model for decision making would be an optimal solution.



## 2.  Research Questions

1. What factors affected the booking rates of an Airbnb listing?
  i) What kind of Airbnb - rooms, facilities, number of beds and bathrooms - have a higher booking rate?
  ii) Do Airbnb hosts with multiple listings achieve better booking rates?
  iii) What kind of services and facilities affect the booking rate of Airbnb?

2. What are the relevant statistics about the DC short term rental market?
  i) Is there any clustering in type of airbnb in areas?
  ii) Which areas have higher booking rates?
  iii) What kind of people visit dc, and what is their purpose?
  iv) What type of housing they might be looking for? In what price range?
  v) Generally what is the trip duration/stay in dc?
  
We focussed mainly on the above two questions because our goal is to provide the investor with recommendations backed up with evidence. If we have knowledge about the factors which affect the booking rates of an Airbnb listing, then the investor would have a fair amount of idea about the amenities that hold most importance, type of properties to invest in, the areas which  are more profitable than others. Secondly, understanding specifics about the Washington DC market will help in making right decisions while investing in DC. Some factors which are profitable in one market might not be of any significance in another market.


```{r}

```
## 3. Methodology


For the first part of the project, which is for the whole US Airbnb market,the initial step was to prepare the data for analysis. The original dataset has more than 60 variables. We definitely needed to narrow it down. We selected variables first by asking ourselves what a customer would look for in an Airbnb. The list was long and not all data could be used directly. We needed to convert into a format that would make sense to us as well as the model. A lot of our time was taken up by data cleaning, transformations, null values handling  and creating new variables . For data preprocessing, we imputed as well as transformed some of the variables:

1. Some entries for the number of bedrooms and bathrooms were missing in the dataset. The missing values accounted for approximately 0.1% of the total. So, the mean value of bedrooms and bathrooms was used to perform the imputation.

2. To consider Review Score into our model, it was important to categorize them. Therefore, we formed three different bins for review i.e. poor, okay and good. After looking at the distribution of review scores; review_scores_rating greater than 90 were categorized as good, less than 90 were categorized as okay, and where null values were present it was categorized as bad.

3. Response times within a day were categorized as good and others were categorized as bad.

4. When security fees and cleaning fees were Null in the dataset, it was imputed with zero. We assume that if the value is missing, it is zero otherwise it would have been mentioned.

5. Years Active was derived using the variable host_since. It was calculated by subtracting the current year from the year the host first listed a property on Airbnb. 
 
6. The number of amenities is calculated from the amenities variable present in the dataset. The number of text entries separated by comma are counted and a new variable no_of_amenities is defined.

We used these variables to build predictive models. After trying logistic regression, random forest, and several other models, we found that xgboost gave the highest performance, with AUC of **0.93**.


```{r}
train <- train %>% mutate(new = as.integer(`{randomControl}`/1000)) %>% filter(new == 107)
```

```{r}
col_in_train <- c("id", "amenities","bathrooms", "bedrooms", "accommodates", "cancellation_policy", "cleaning_fee", "extra_people", "host_is_superhost","host_listings_count", "price", "review_scores_rating", "high_booking_rate", "host_response_rate","host_response_time", "minimum_nights", "security_deposit", "property_type", "latitude","longitude")
```

```{r}
dc_data <- train[col_in_train]
```

```{r}
dc_data <- dc_data %>% mutate(amenities = tolower(amenities))
```

```{r}
must_have_amenities <- c("parking")
dc_data <- dc_data %>% bind_cols(as.data.frame(sapply(must_have_amenities, grepl, dc_data$amenities)))
```

```{r}
recode_policy <- as.list(dc_data %>% group_by(cancellation_policy) %>% tally() %>% mutate(pct = n/sum(n)*100) %>% filter(pct < 10))[1]
```

```{r}
apartment <- c('Apartment', 'Aparthotel', 'Boutique hotel', 'Condominium', 'Hotel', 'Loft', 'Serviced apartment', 'Guest suite')

house <- c('Bungalow', 'Villa', 'Castle', 'Cabin', 'Hut', 'Cottage', 'Barn', 'Tiny house', 'Bed and breakfast', 'Casa particular (Cuba)', 'Townhouse', 'Earth house', 'Chalet', 'Dome house', 'Guesthouse', 'House', 'In-law', 'Nature lodge', 'Resort', 'Vacation home')
```

```{r}
dc_data <- dc_data %>% mutate(high_booking_rate = as_factor(high_booking_rate),
                                  no_of_amenities = sapply(strsplit(amenities, ","), length),
                                  cancellation_policy = if_else(cancellation_policy %in% unlist(recode_policy),"Other",cancellation_policy),
                                  cancellation_policy = as_factor(cancellation_policy),
                                  property_type = if_else(property_type %in% apartment,"apartment", if_else(property_type %in% house,"house","other")),
                                  property_type = as_factor(property_type),
                                  cleaning_fee = as.numeric(gsub('\\$|,', '', cleaning_fee)),
                                  cleaning_fee = if_else(is.na(cleaning_fee),0,cleaning_fee),
                                  extra_people = as.numeric(gsub('\\$|,', '', extra_people)),
                                  price = as.numeric(gsub('\\$|,', '', price)),
                                  derived_review = if_else(review_scores_rating >= 90, "Good",if_else(review_scores_rating >0 & review_scores_rating < 90, "Okay", "Poor")),
                                  derived_review = if_else(is.na(derived_review),"Poor",derived_review),
                                  derived_review = as_factor(derived_review),
                                  host_response_rate = as.numeric(gsub('\\%|,', '', host_response_rate)),
                                  host_response_rate = if_else(host_response_rate > 90, "Good","Bad"),
                                  host_response_rate = if_else(is.na(host_response_rate),"Bad",host_response_rate),
                                  host_response_rate = as_factor(host_response_rate),
                                  host_response_time = if_else(host_response_time %in% c("within an hour", "within a few hours","within a day"),"Good", "Bad"),
                                  host_response_time = as_factor(host_response_time),
                                  minimum_nights = if_else(minimum_nights <= 2, "Good", "Bad"),
                                  minimum_nights = as_factor(minimum_nights),
                                  security_deposit = as.numeric(gsub('\\$|,', '', security_deposit)),
                                  security_deposit = if_else(is.na(security_deposit),0,security_deposit),
                                  host_is_superhost = if_else(is.na(host_is_superhost),FALSE,host_is_superhost),
                                  bedrooms = if_else(is.na(bedrooms),mean(bedrooms, na.rm = TRUE),bedrooms),
                                  bathrooms = if_else(is.na(bathrooms),mean(bathrooms, na.rm = TRUE),bathrooms),
                                  host_listings_count = if_else(is.na(host_listings_count),mean(host_listings_count, na.rm = TRUE),host_listings_count))
```

```{r}
remove_var <- c("amenities","review_scores_rating")
dc_data <- dc_data[!names(dc_data) %in% remove_var]
```

```{r, include=FALSE}
skim(dc_data)
```


For the second part of our project we focus on the Washington DC market; the capital of the United States, a culturally rich, compact city with many monuments and museums. If we look at the data of visitors to DC, the majority come to the city with the purpose of Vacation. And with DC being the 10th biggest visitor market in the US, it is worthwhile to understand the market better. With the knowledge we gained from the Kaggle competition and the market research, we moved on to explore the data for DC:

1. Price is of course a necessary variable to explore. There is a large section of people that chooses Airbnbs for their low rates. Do high priced Airbnbs do as well as low priced Airbnbs?  We see from the boxplots that Airbnbs with unreasonably high prices will not achieve a high booking rate. An interesting thing to note is that the one priced at 10000 is a typing error, but it is the listing of Veep Suite at Hamilton Hotel Washington D.C, a replica of the set of the Emmy winning HBO series VEEP. 



```{r}
dc_data %>% filter(price <= 1000) %>% ggplot(aes(y = price, x = high_booking_rate, fill = high_booking_rate)) + geom_boxplot() + xlab("High Booking Rate") + ylab("Rental Price") + ggtitle("Rental Price Distribution")+scale_fill_manual(values=c( "#d10000","#00d126")) + theme_minimal()
```




2. When there are a lot of homes to choose from, would the number of amenities influence the customer? This question motivated us to plot this graph. The graph shows the distribution of the number of amenities divided by high booking rate. From this stacked histogram, we can see having high amenities influences the listings to have a high booking rate.


```{r}
dc_data %>% ggplot(aes(y = no_of_amenities, x = high_booking_rate, fill = high_booking_rate)) + geom_boxplot() + xlab("High Booking Rate") + ylab("No of Amenitites") +theme_minimal() + scale_fill_manual(values=c( "#d10000","#00d126")) + ggtitle("Amenities Distribution")
```







```{r, include=FALSE}
ggplot(dc_data, aes(fill=high_booking_rate, y=frequency(bedrooms), x=bedrooms)) + geom_bar(position="stack", stat="identity") + xlab("Count of Airbnb") + ylab("Bedrooms") + ggtitle("Count of Airbnb Rental according to bedroom distribution") +theme_classic() + xlim(0,5) + scale_fill_manual(values=c( "#d10000","#00d126"))
```

```{r, include=FALSE}
ggplot(dc_data, aes(fill=high_booking_rate, y=frequency(bathrooms), x=bathrooms)) + geom_bar(position="stack", stat="identity", width = 0.4) + xlab("Count of Airbnb") + ylab("Bathrooms") + ggtitle("Count of Airbnb Rental according to bathroom distribution") +theme_classic() + xlim(0, 5)
```


3. Having good reviews is always good for business. And we reach the same conclusion that we had for parking. Even if good reviews won’t guarantee a greater number of bookings, having poor reviews makes you susceptible to low booking rates.



```{r}
ggplot(data.frame(dc_data %>% xtabs(~high_booking_rate+derived_review, .)), aes(fill = high_booking_rate, y = Freq, x = derived_review)) + geom_bar(position = "dodge", stat = "identity", width = 0.4) + xlab("Customer Reviews") + ylab("Count of Airbnb") + ggtitle("Count of Airbnb Rental with Customer Review") + theme_classic() + scale_fill_manual(values=c( "#d10000","#00d126"))
```






4. DC has 23 million annual visitors and 20 million of them are domestic travellers. So we thought parking could be a good variable to explore. We found that having parking space won’t guarantee you a high booking rate but not having them makes you more likely to have low booking rates. So this is an approach of avoiding certain situations that will make the listing have a low booking rate. 



```{r}
ggplot(data.frame(dc_data %>% xtabs(~high_booking_rate+parking, .)), aes(fill = high_booking_rate, y = Freq, x = parking)) + geom_bar(position = "dodge", stat = "identity", width = 0.4) + xlab("Parking") + ylab("Count of Airbnb") + ggtitle("Count of Airbnb Rental with Parking Availability") + theme_classic() + scale_fill_manual(values=c( "#d10000","#00d126"))
```





5. It is important for an investor to know what kind of property he should buy and where. So through this visualization for the Washington DC market, we found out that apartments are concentrated in the central part of the market whereas houses and other property types are mostly found in the suburbs of the city.

![Distribution of House Types](F:\data_mining\kaggle\code\1.PNG) 


6. We had an initial hypothesis that location would affect booking rates. But here we can see that there is no cluster of Airbnbs with a high or low booking rate in the market. There is no particular neighborhood which can be thought of as an area of high booking rate Airbnbs.

![High Booking Rate](F:\data_mining\kaggle\code\2.PNG)

![Low Booking Rate](F:\data_mining\kaggle\code\3.PNG) 



7. In following types of combinations, atleast 30% of properties achieve high booking rate 
For apartments: Studio, 1 Bed and 1 Bath, 2 Bed and 1/2 Bath, 3 Bed and 2.5 Bath
For houses: 1 Bed and 1/1.5 Bath,  2 Bed and 1/2 Bath, 3 Bed and 2/2.5 Bath

```{r}
dc_data %>% select(property_type, bedrooms,bathrooms, high_booking_rate) %>% group_by(property_type, bedrooms, bathrooms, high_booking_rate) %>% tally() %>% spread(high_booking_rate,n) %>% rename("Low_Booking_Rate" = "0", "High_Booking_Rate" = "1") %>% mutate(Percentage = High_Booking_Rate/(Low_Booking_Rate+High_Booking_Rate)*100) %>% arrange(desc(property_type,Percentage)) %>% filter(Low_Booking_Rate+High_Booking_Rate >= 100)
```

----------------------------------------------------------------------------------------------------
# 4. Modeling

Modeling for the DC market, we developed a Logistic Regression model for Exploratory purposes as the importance of the variables can be explained and XGBoost for prediction because even though it does not explain variables, it gives more accurate predictions.

Specificity (True Negative Rate) is more important as investing in a unit that is not highly bookable would be costly. Here, we try to decrease the percentage of false positives.

There are multiple ways of selecting a cut-off.

Cut off  <= 0.4 

There will be more false positive cases here, which means that the investor will invest in more Airbnbs which will have low booking rates, which would be costly.

Cut off >= 0.6 

If the investor is risk averse, then it would be an ideal case to pursue. Here, there would be more missed opportunities, but the amount of capital lost in risky properties investment will be lower. This is a risk averse situation.

Cut off = 0.5 

This is a risk neutral scenario, which is a balance between the scenario one and two.

Hence the cutoff will be modified depending on how much risk an investor is willing to take.

```{r}
set.seed(333)
dc_train <- sample_frac(dc_data,0.8)
dc_test <- dplyr::setdiff(dc_data, dc_train)
```

```{r}
dc_logistic <- glm(high_booking_rate ~ . -id -accommodates -latitude - longitude, family = binomial(), data = dc_train)
``` 

```{r}
summary(dc_logistic)
```

```{r, include=FALSE}
car::vif(dc_logistic)
```

```{r}
predict_dc_logistic <- predict(dc_logistic, dc_test, type = "response") %>% 
  bind_cols(dc_test, predictionProb = .) %>% 
  mutate(predictedClass = if_else(predictionProb >= 0.5,1,0))
```

```{r}
predict_dc_logistic %>% xtabs(~predictedClass+high_booking_rate, .) %>% 
  confusionMatrix(positive = '1')
```

```{r}
set.seed(2020)

dc_xgboost <- train(high_booking_rate ~ . -id -bedrooms -latitude - longitude, data=dc_train, method='xgbTree', trControl=trainControl(method='cv', number=10))
```


```{r}
predict_dc_xgboost <-
  dc_xgboost %>% 
  predict(dc_test, type='prob') %>% 
  bind_cols(dc_test, predictedProb=.$"1") %>% 
  mutate(predictedClass = if_else(predictedProb >= 0.5,1,0))
```

```{r}
predict_dc_xgboost %>% xtabs(~predictedClass+high_booking_rate, .) %>% 
  confusionMatrix(positive = '1')
```

```{r, include=FALSE}
library(AUC)
```

```{r}
logistic <- predict(dc_logistic,dc_test, type='response') %>% 
  bind_cols(dc_test,PredictedProb= .) %>% 
  mutate(model = "Logistic") 

xgb <- predict(dc_xgboost,dc_test, type='prob') %>% 
  bind_cols(dc_test,PredictedProb= .$"1") %>% 
  mutate(model = "XGB") 

modelAll <- bind_rows(logistic, xgb)

modelAll %>%
  group_by(model) %>% 
  roc_curve(truth = high_booking_rate, PredictedProb) %>% 
  ggplot(aes(x = 1 - specificity, y = sensitivity, color = model)) +
  geom_line(size = 1.1) +
  geom_abline(slope = 1, intercept = 0, size = 0.4) +
  coord_fixed() +
  theme_cowplot()
```

```{r}
modelAll %>%
  group_by(model) %>%
  roc_auc(truth = high_booking_rate, PredictedProb) %>% 
  arrange(desc(.estimate))
```
# 5. Results and Findings

We were able to answer almost all of the questions we had set out to answer. 
We find that while buying the property, the combinations given below have around 30% chance of achieving high booking rate, all others have less than 20% (And as previously seen location has no effect on booking rate);
Property Type:
Central DC: Apartments with parking
Suburbs: Houses with parking
Bedrooms and Bathroom:
For apartments: Studio, 1 Bed and 1 Bath, 2 Bed and 1/2 Bath, 3 Bed and 2.5 Bath
For houses: 1 Bed and 1/1.5 Bath,  2 Bed and 2/2.5 Bath, 3 Bed and 2/2.5 Bath
This makes sense as most people visit DC for vacation purposes, stay for an average of 3 nights and consist of small families. Apartments and houses of these sizes, which do not charge exorbitant prices, suffice their purpose. 
It would also be good to buy multiple properties and turn them into Airbnbs as we find that host with multiple listings have a higher chance of getting bookings. It is always good to diversify as it decreases the chance of loss.

To support our recommendation, below mentioned are the key variables that we found, converted to make the business decision making process a bit easier.

* If the price is increased by $20, then the odds of getting a high booking rate is decreased by 18%, keeping everything else as constant.

* For the response time, the odds of a host who takes more than a day to reply having a high booking rate are 70% lower than the odds of an Airbnb who takes less than a day to reply, keeping everything else constant.

* The odds of a superhost having a high booking rate are  80%  higher than the odds of a non-superhost, keeping everything else as constant.

* Increasing the number of people staying in the rental by 2 is associated with an increase in the odds of a high booking rate by 28%, keeping everything else as constant.

* The odds of an Airbnb with parking having a high booking rate are 30% higher than the odds of an Airbnb with no parking facility, keeping everything else constant.

* The odds of an Airbnb property classified as a house having a high booking rate are 11% higher than the odds of other types of Airbnb properties, keeping everything else constant.

We now know which variables are important but how much importance should be given to each of them? And what should we keep in mind about them? Why are they important? The graph below shows the variable importance given by  our XGBoost prediction model. While being a superhost has maximum weightage, that is not in our hands. Instead, an Airbnb host should focus on aggregating good reviews by providing excellent customer service, keeping the price competitive with the other listings in the area, responding to queries within a day and charging a minimum cleaning and security fee. The reason these variables have high importance is because following these will lead you one step closer to being a superhost.

```{r}
plot(varImp(dc_xgboost), top=20)
```

# Conclusion and Limitations

Through this project, we were able to get several interesting insights about the Airbnb market in DC. Below we will summarize the answers to the questions that we wished to answer at the beginning of the project:
Maximum people visit DC for Vacations and Business purposes with an average trip duration of 3 nights and prefer an apartment or a house for staying. The properties having more number of amenities along with 1 to 3 beds and 1 to 2.5 baths have better booking rate. Moreover, the hosts who are superhost, have good reviews, keep competitive prices, quick response rate and multiple rentals have more chances of getting a high booking rate on their properties. 

However in this project, we faced a limitation of not having a time series data for the property market of DC. If we have data which explains the growth of properties in particular areas over time then it could help in improving the predictions significantly. A future research could be made to determine what feature is the correct choice of measure for investment. As one of our observations suggests the Veep Suite at Hamilton Hotel Washington D.C which is priced at $10,000 per night has a low booking rate, but it could lead to high profits even with few bookings around the year. Hence, to know the previous statistics about revenue generated from a property would help to predict if investment will lead to desired return of investment.

# References
1. Washington, DC Visitor Research. (2019, October 31). Retrieved May 7, 2020, from https://washington.org/press/dc-information/washington-dc-visitor-research

2. Strupp, J. (2019, April 4). Single-family homes take up a lot of space in the District. Retrieved May 7, 2020, from https://ggwash.org/view/71576/heres-how-much-of-dcs-housing-consists-of-single-family-homes

3. Washington, DC Facts. (2020, March 31). Retrieved May 7, 2020, from https://washington.org/dc-information/washington-dc-facts

4. DC Short Term Rental Laws: What's Changing In October 2019 | Nomadic Real Estate | Markets Insider. (n.d.). Retrieved May 7, 2020, from https://markets.businessinsider.com/news/stocks/dc-short-term-rental-laws-what-s-changing-in-october-2019-nomadic-real-estate-1028578319

